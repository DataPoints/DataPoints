<script>
    $(function () {
        $('#test_chart').highcharts({
            title: {
                text: 'Users graph',
                x: -20 //center
            },

            xAxis: {

                categories: <%=raw @xData %>
            },

            yAxis: {
                title: {
                    text: 'Selected Column'
                },

                plotLines: [{
                    value: 0,
                    width: 1,
                    color: '#808080'
                }]
            },

            legend: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'middle',
                borderWidth: 0
            },

            series: [{
                name: 'Y axis',
                data: <%=raw @yData %>
            }]
        });
    });
</script>
<script>
    google.maps.event.addDomListener(window, 'load', initMap);

    $(document).ready(initMap());

    function initMap() {
        var handler = Gmaps.build('Google');
        handler.buildMap({internal: {id: 'map'}}, function () {
            var markers = handler.addMarkers([
                <% @coordinates.each do |coordinate| %>
                <%= "{ lat: #{coordinate.lat}, lng: #{coordinate.lng}, infowindow: \"#{coordinate.mesto}\" },".html_safe %>
                <% end %>
            ]);
            handler.bounds.extendWith(markers);
            handler.fitMapToBounds();
        });
    }

    function ShowMap() {
        document.getElementById('MapWrapper').style.display = "block";
        initMap()
    }

    function HideMap() {
        document.getElementById('MapWrapper').style.display = "none";
    }
</script>

<div class="row">
  <div class="col-md-6">
    <%= link_to 'Back', datasets_path, class: 'btn btn-default pull-left' %>
    <br /><br /><br />
    <table class="table table-striped">
      <tr>
        <td><b>Dataset name: </b></td>
        <td><%= @dataset.name %></td>
      </tr>
      <tr>
        <td><b>Dataset description: </b></td>
        <td><%= @dataset.description %></td>
      </tr>
      <tr>
        <td><b>Dataset created at: </b></td>
        <td><%= @dataset.created_at.strftime('%d %b %H:%M') %></td>
      </tr>
      <tr>
        <td><b>Dataset updated at: </b></td>
        <td><%= @dataset.updated_at.strftime('%d %b %H:%M') %></td>
      </tr>
      <tr>
        <td><b>Dataset analyzed progress: </b></td>
        <td> <%= @dataset.analyzed_progress %></td>
      </tr>
      <tr>
        <td><b>Dataset number of rows: </b></td>
        <td> <%= @data.count %></td>
      </tr>
    </table>
  </div>
  <div class="col-md-6">
    <div id="MapWrapper" style='width: 100%; margin: auto; border: solid; box-shadow: 4px; padding: 1px; display: block;'>
      <div id="map" style='width: 100%; height: 400px;'></div>
    </div>
    <br />
    <button type="button" class="btn btn-default" onclick="ShowMap()">Show map</button>
    <button type="button" class="btn btn-default" onclick="HideMap()">Hide map</button>
  </div>
</div>

<hr />

<div class="row">
  <div class="col-md-12">
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-default btn-lg" data-toggle="modal" data-target="#myModal">
      Start Analysis
    </button>
    <br />
    <br />
    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="myModalLabel">Analyze Information</h4>
          </div>
          <div class="modal-body">
            Analyze can take a lot of time. Go for a cup of coffee and chillax. We will send you a email to let you know, that your dataset is over.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <%= form_tag({controller: 'datasets', action: 'start_analyze'}, method: 'get', class: 'jahoda', data: {status: @dataset.status} ) do %>
              <%= hidden_field_tag :id , @dataset.id %>
              <%= submit_tag 'Start Analyze', class: 'btn btn-primary' %>
            <% end %>
          </div>
        </div>
      </div>
    </div>

<!--<%= @dataset.status %>-->
<% if @dataset.status == "S" %>
    Neanalyzovany
<% end %>
<% if @dataset.status == "WA" %>
    Analyza prave prebieha
<% end %>
<% if @dataset.status == "EA" %>
    Analyza uspesne ukoncena
    <%= @dataset.analysis_results[0].result %>
<% end %>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <table class="table table-striped table-bordered">
        <tr>
            <th>index</th>
            <th>analysis progress</th>
            <th>analysis result</th>
        </tr>
        <% @dataset.analysis_results.each_with_index do |result, index| %>
            <tr>
                <td><%= index + 1 %></td>
                <td><%= result.analysisProgress  %></td>
                <td>
                  <% if result.analysisProgress == 100 %>
                    <%= result.result %>
                  <% else %>
                      Analysis still in progress
                  <% end %>
                </td>
            </tr>
         <% end %>
    </table>
  </div>
</div>

<hr />

<div class="row">
  <div class="col-md-12" id="data-table">
    <!-- table of data with changing header type -->
    <table class="table table-striped table-bordered">
      <!-- changing header type -->
      <tr>
        <td></td>
        <% @columns.each do |column| %>
            <td>
              <%= form_tag({controller: 'datasets', action: 'change_type'}, method: 'get') do %>
                  <%= hidden_field_tag :id, @dataset.id %>
                  <%= hidden_field_tag :column_id, column.id %>
                  <%= select_tag(:type_id, options_for_select(@types.collect { |type| [type.name, type.id] }, column.type_id ), :onchange => ("$(this).parent('form').submit();")) %>
              <% end %>
            </td>
        <% end %>
      </tr>
      <!-- header line -->
      <tr>
        <% for i in 0...@names_of_data_columns.count %>
            <th><%= @names_of_data_columns[i] %></th>
        <% end %>
      </tr>
      <!-- generating matrix of data -->
      <% for i in 1..@number_of_data_rows do %>
          <% data_row = @data.find(i) %>
          <tr>
            <% for j in 0...@names_of_data_columns.count %>
                <td><%= data_row[@names_of_data_columns[j]] %></td>
            <% end %>
          </tr>
      <% end %>
      <!-- summary for each column -->
      <tr class="stats">
        <th>MIN<br>MAX<br>MEAN<br>MEDIAN</th>
        <% @columns.each do |column| %>
            <th>
              <% @summaries.each do |summary| %>
                  <% if (summary.dataset_id == @dataset.id) and (summary.header == column.label) %>
                      <%= summary.min %><br>
                      <%= summary.max %><br>
                      <%= summary.mean %><br>
                      <%= summary.median %><br>
                  <% end %>
              <% end %>
            </th>
        <% end %>
      </tr>
    </table>
  </div>
  <div class="col-md-3" id="jira-okno">
    <table class="table table-striped table-bordered">
      <tr>
        <td>
          <button class="btn btn-default glyphicon glyphicon-remove pull-right" id="close-jira-okno"> Close </button>
          <br class="blear"/>
        </td>
      </tr>
      <tr>
        <th>
          <span class='glyphicon glyphicon-eye-open'></span>
          Row details
        </th>
      </tr>
      <tr>
        <td class="body"></td>
      </tr>
    </table>
  </div>
</div>

<hr />

<div clas="row">
  <div class="col-md-12">
    <%= form_tag({controller: 'datasets', action: 'change_X_Y'}, method: 'get') do %>
        X
        <%= select_tag(:column_x, options_for_select(@columns.collect { |column| [column.label, column.id] })) %>
        Y
        <%= select_tag(:column_y, options_for_select(@columns.collect { |column| [column.label, column.id] })) %>
        <%= hidden_field_tag :id, @dataset.id %>

        <%= submit_tag 'Choose', class: 'btn btn-default', style: 'margin: 0' %>
    <% end %>
  </div>
</div>

<br />
<br />
<br />

<div clas="row">
  <div class="col-md-12">
    <div id='test_chart' style=" width: 100%; height: 300px;margin: auto ;"></div>
  </div>
</div>

<script>
    $(function() {
        var dataTable = $("#data-table");
        var jiraOkno = $("#jira-okno");
        var closeJiraOkno = $("#close-jira-okno");
        var header = $("th", dataTable);

        $('.body', jiraOkno).append('<table class="table table-striped table-bordered">');
        header.each(function(){
            row = '<tr>';
            row += '<td class="text-left">';
            row += '<strong>'+ $(this).text() +'</strong>';
            row += ': </td>';
            row += '<td class="text-left"></td>';
            row += '</tr>';

            $('.body', jiraOkno).append(row);
        });
        $('.body', jiraOkno).append('</table>');


        closeJiraOkno.click(function () {
            dataTable.removeClass('col-md-9');
            dataTable.addClass('col-md-12');
            jiraOkno.css({ display: 'none' });
        });

        $("tr", dataTable).click(function () {
            dataTable.removeClass('col-md-12');
            dataTable.addClass('col-md-9');
            jiraOkno.css({ display: 'block' });
        });

        $("tr", dataTable).not('.stats').hover(function () {
            data = $("td", this);

            data.each(function(index){
                $('.body tr:nth-child('+ (index+1) +') td:nth-child(2)', jiraOkno).text( $(this).text() );
            });
        });

    });
</script>
