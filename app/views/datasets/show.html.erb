<script>
    $(function () {
        $('#test_chart').highcharts({
            title: {
                text: 'Users graph',
                x: -20 //center
            },

            xAxis: {

                categories: <%=raw @xData %>
            },

            yAxis: {
                title: {
                    text: 'Selected Column'
                },

                plotLines: [{
                    value: 0,
                    width: 1,
                    color: '#808080'
                }]
            },

            legend: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'middle',
                borderWidth: 0
            },

            series: [{
                name: 'Y axis',
                data: <%=raw @yData %>
            }]
        });
    });
</script>

<script>
    $(function () {
        $('#histogram').highcharts({
            chart: {
                type: 'column'
            },
            title: {
                text: 'Users Histogram'
            },
            xAxis: {
                type: 'category',
                labels: {
                    rotation: -45,
                    style: {
                        fontSize: '13px',
                        fontFamily: 'Verdana, sans-serif'
                    }
                }
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Number of Occurences'
                }
            },
            legend: {
                enabled: false
            },
            series: [{
                name: 'Population',
                data: [<%=raw @hData %>],
                dataLabels: {
                    enabled: true,
                    rotation: -90,
                    color: '#FFFFFF',
                    align: 'right',
                    format: '{point.y:.1f}', // one decimal
                    y: 10, // 10 pixels down from the top
                    style: {
                        fontSize: '13px',
                        fontFamily: 'Verdana, sans-serif'
                    }
                }
            }]
        });
    });
</script>

<% if @coordinates.size > 0 %>
<script>
        google.maps.event.addDomListener(window, 'load', initMap);

        $(document).ready(initMap());

        function initMap() {
            var handler = Gmaps.build('Google');
            handler.buildMap({internal: {id: 'map'}}, function () {
                var markers = handler.addMarkers([
                    <% @coordinates.each do |coordinate| %>
                    <%= "{
                                lat: #{coordinate.lat},
                                lng: #{coordinate.lng},
                                infowindow: \"#{coordinate.mesto}\"
                         },".html_safe %>
                    <% end %>
                ]);
                handler.bounds.extendWith(markers);
                handler.fitMapToBounds();
            });
        }

        function ShowMap() {
            document.getElementById('MapWrapper').style.display = "block";
            initMap()
        }

        function HideMap() {
            document.getElementById('MapWrapper').style.display = "none";
        }
    </script>
<% end %>

<div class="row">
  <div class="col-md-6">
    <%= link_to datasets_path, class: 'btn btn-default pull-left' do %>
        <span class="glyphicon glyphicon-chevron-left"></span>
        Back
    <% end %>
    <br/><br/><br/>
    <table class="table table-striped">
      <tr>
        <td class="text-left"><strong>Dataset name: </strong></td>
        <td class="text-left"><%= @dataset.name %></td>
      </tr>
      <tr>
        <td class="text-left"><strong>Dataset description: </strong></td>
        <td class="text-left"><%= @dataset.description %></td>
      </tr>
      <tr>
        <td class="text-left"><strong>Dataset created at: </strong></td>
        <td class="text-left"><%= @dataset.created_at.strftime('%d %b %H:%M') %></td>
      </tr>
      <tr>
        <td class="text-left"><strong>Dataset updated at: </strong></td>
        <td class="text-left"><%= @dataset.updated_at.strftime('%d %b %H:%M') %></td>
      </tr>
      <tr>
        <td class="text-left"><strong>Dataset analyzed progress: </strong></td>
        <td class="text-left"><%= @dataset.analyzed_progress %></td>
      </tr>
      <tr>
        <td class="text-left"><strong>Dataset number of rows: </strong></td>
        <td class="text-left"><%= @data.count %></td>
      </tr>
    </table>
  </div>
  <div class="col-md-6">

    <% if @coordinates.size > 0 %>
        <div id="MapWrapper" style='width: 100%; margin: auto; border: solid; box-shadow: 4px; padding: 1px; display: block;'>
          <div id="map" style='width: 100%; height: 400px;'></div>
        </div>
        <br/>
        <button type="button" class="btn btn-default" onclick="ShowMap()">
          <span class="glyphicon glyphicon-map-marker"></span>
          Show map
        </button>
        <button type="button" class="btn btn-default" onclick="HideMap()">
          <span class="glyphicon glyphicon-remove"></span>
          Hide map
        </button>
        </div>
    <% end %>

</div>

<div class="col-sm-12">
    <hr />
</div>

<div class="row">
  <div class="col-md-12">
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-default btn-lg" data-toggle="modal" data-target="#myModal">
      <span class="glyphicon glyphicon-stats"></span>
      Start Analysis
    </button>
    <br/>
    <br/>
    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">
              <span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="myModalLabel">Analyze Information</h4>
          </div>
          <div class="modal-body">
            Analysis can take a lot of time. Go for a cup of coffee and chillax. We will send you a email to let you know, that your dataset is over.
            Analyze can take a lot of time. Go for a cup of coffee and chillax. We will send you a email to let you
            know, that your dataset is over.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <%= form_tag({controller: 'datasets', action: 'start_analyze'}, method: 'get', class: 'jahoda', data: {status: @dataset.status}) do %>
                <%= hidden_field_tag :id, @dataset.id %>
                <%= submit_tag 'Start Analyze', class: 'btn btn-default' %>
            <% end %>
          </div>
        </div>
      </div>
    </div>

<!--<%= @dataset.status %>-->
<% if @dataset.status == "S" %>
    Not analyzed
<% end %>
<% if @dataset.status == "WA" %>
    Analysis is in progress
<% end %>
<% if @dataset.status == "EA" %>
    Analysis successfully completed
    <%= @dataset.analysis_results[0].result %>
<% end %>
    <!--<%= @dataset.status %>-->
    <% if @dataset.status == "S" %>
        Neanalyzovany
    <% end %>
    <% if @dataset.status == "WA" %>
        Analyza prave prebieha
    <% end %>
    <% if @dataset.status == "EA" %>
        Analyza uspesne ukoncena
        <%= @dataset.analysis_results[0].result %>
    <% end %>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <table class="table table-striped table-bordered">
      <tr>
        <th>index</th>
        <th>analysis progress</th>
        <th>analysis result</th>
      </tr>
      <% @dataset.analysis_results.each_with_index do |result, index| %>
          <tr>
            <td><%= index + 1 %></td>
            <td><%= result.analysisProgress %></td>
            <td>
              <% if result.analysisProgress == 100 %>
                  <%= result.result %>
              <% else %>
                  Analysis still in progress
              <% end %>
            </td>
          </tr>
      <% end %>
    </table>
  </div>
</div>

<hr/>

<div class="row">
  <a name="type"></a>

  <div class="col-md-12" id="data-table">
    <!-- table of data with changing header type -->
    <table class="table table-striped table-bordered">
      <!-- changing header type -->
      <tr class="change-type">
        <td></td>
        <% @columns.each do |column| %>
            <td>
              <%= form_tag({controller: 'datasets', action: 'change_type'}, method: 'get') do %>
                  <%= hidden_field_tag :id, @dataset.id %>
                  <%= hidden_field_tag :column_id, column.id %>
                  <%= select_tag(:type_id, options_for_select(@types.collect { |type| [type.name, type.id] }, column.type_id), :onchange => ("$(this).parent('form').submit();")) %>
              <% end %>
            </td>
        <% end %>
      </tr>
      <!-- header line -->
      <tr class="header">
        <% for i in 0...@names_of_data_columns.count %>
            <th><%= @names_of_data_columns[i] %></th>
        <% end %>
      </tr>
      <!-- generating matrix of data -->
      <% @data.each do |data_row| %>
          <tr class="body">
            <% for j in 0...@names_of_data_columns.count %>
                <td><%= data_row[@names_of_data_columns[j]] %></td>
            <% end %>
          </tr>
      <% end %>
      <!-- summary for each column -->
      <tr class="stats">
        <th>MIN<br>MAX<br>MEAN<br>MEDIAN</th>
        <% @columns.each do |column| %>
            <th>
              <% @summaries.each do |summary| %>
                  <% if (summary.dataset_id == @dataset.id) and (summary.header == column.label) %>
                      <%= summary.min %><br>
                      <%= summary.max %><br>
                      <%= summary.mean %><br>
                      <%= summary.median %><br>
                  <% end %>
              <% end %>
            </th>
        <% end %>
      </tr>
    </table>
    <div>
      <%= paginate @data %>
    </div>


  </div>
  <div class="col-md-3" id="jira-okno">
    <table class="table table-condensed">
      <tr>
        <td>
          <button class="btn btn-default pull-right" id="close-jira-okno">
            <span class='glyphicon glyphicon-remove'></span>
            Close
          </button>
          <br class="blear"/>
        </td>
      </tr>
      <tr>
        <th>
          <span class='glyphicon glyphicon-eye-open'></span>
          Row details
        </th>
      </tr>
      <tr>
        <td class="body">
          <!-- Here will JQuery add data -->
        </td>
      </tr>
      <tr>
        <td class="fin_foaf">
          <!-- Here will JQuery add Finstat and Foaf buttons -->
        </td>
      </tr>
    </table>
  </div>
</div>

<hr/>

<div clas="row">
  <a name="change"></a>

  <div class="col-md-12">
    <%= form_tag({controller: 'datasets', action: 'change_X_Y'}, method: 'get') do %>
        <label>X</label>
        <%= select_tag(:column_x, options_for_select(@columns.collect { |column| [column.label, column.id] }, @xType)) %>
        <label>Y</label>
        <%= select_tag(:column_y, options_for_select(@columns.collect { |column| [column.label, column.id] }, @yType)) %>

        <%= hidden_field_tag :id, @dataset.id %>

        <% if !params[:column_h].nil? %>
            <%= hidden_field_tag :column_h,params[:column_h] %>
        <% end %>

        <%= button_tag(type: 'submit', class: 'btn btn-default') do %>
            <span class="glyphicon glyphicon-refresh"></span>
            Choose
        <% end %>
    <% end %>
  </div>
</div>

<br/>
<br/>
<br/>

<div clas="row">
  <div class="col-md-12">
    <div id='test_chart' style=" width: 100%; height: 300px;margin: 0 ;"></div>
  </div>
</div>

<div class="row" style="margin: 315px 0 0 0">
  <div class="col-md-12">
    <%= form_tag({controller: 'datasets', action: 'change_X_Y'}, method: 'get') do %>
        <%= hidden_field_tag :column_x, @actualXColumn %>
        <%= hidden_field_tag :column_y, @nextNumericColumn %>
        <%= hidden_field_tag :id, @dataset.id %>

        <% if !params[:column_h].nil? %>
        <%= hidden_field_tag :column_h,params[:column_h] %>
        <% end %>
        <% if(@nextNumericColumnName != nil) %>
            <%= submit_tag 'Switch Y to "'+@nextNumericColumnName+'" column', class: 'btn btn-default', style: 'margin: 0' %>
        <% end %>
    <% end %>
  </div>
</div>

<br />
<br />
<br />

<div clas="row">
  <a name="change"></a>
  <div class="col-md-12">
    <%= form_tag({controller: 'datasets', action: 'show'}, method: 'get') do %>
        <label>H</label>
        <%= select_tag(:column_h, options_for_select(@columns.collect { |column| [column.label, column.id] })) %>

        <%= hidden_field_tag :id, @dataset.id %>

        <%= button_tag(type: 'submit', class: 'btn btn-default') do %>
            <span class="glyphicon glyphicon-refresh"></span>
            Choose
        <% end %>
    <% end %>
  </div>
</div>

<div clas="row">
  <div class="col-md-12">
    <div id='histogram' style=" width: 100%; height: 300px;margin: auto ;"></div>
  </div>
</div>

<script>
    function handleJiraOkno() {
        var dataTable = $("#data-table");
        var jiraOkno = $("#jira-okno");
        var closeJiraOkno = $("#close-jira-okno");
        var header = $("th", dataTable).not('.stats th');
        var ico_index = null;
        var company_index = null;

        var selects = document.getElementsByName("type_id");

        for (i = 0; i < selects.length; i++) {
            if (selects[i].value == 7) {
                ico_index = i + 1;
            } else if (selects[i].value == 8) {
                company_index = i + 1;
            }
        }

        <!-- Generating TABLE with labels and empty values-->
        table = '<table class="table table-striped">';
        header.each(function (index) {

            row = '<tr>';
            row += '<td class="text-left">';
            row += '<strong>' + $(this).text() + ':</strong>';
            row += '</td>';
            row += '<td class="text-left"></td>';
            row += '</tr>';
            table += row;
        });

        table += '</table>';
        $('.body', jiraOkno).append(table);

        // Adding Finstat and Foaf buttons to TABLE if dataset has ICO or Company name
        if (ico_index !== null || company_index !== null) {
            fin_foaf = '<table class="table table-transparent">';
            fin_foaf += '<tr><td></td><td></td></tr>';
            fin_foaf += '</table>';
            $('.fin_foaf', jiraOkno).append(fin_foaf);
        }

        // FUNCTION for closing JIRA Window
        closeJiraOkno.click(function () {
            dataTable.removeClass('col-md-9');
            dataTable.addClass('col-md-12');
            jiraOkno.css({display: 'none'});
        });

        // FUNCTION for opening JIRA Window
        $("tr.body", dataTable).click(function () {
            dataTable.removeClass('col-md-12');
            dataTable.addClass('col-md-9');
            jiraOkno.css({display: 'block'});
        });

        // Reading values from actual row
        $("tr.body", dataTable).click(function () {
            data = $("td", this);

            data.each(function (index) {
                // If ICO or if Company exist, fill button link
                if (ico_index !== null && ico_index == index) {
                    $('.fin_foaf tr:nth-child(1) td:nth-child(1)', jiraOkno).html('<a href="http://www.finstat.sk/Hladaj?query=' + $(this).text() + '" class="btn btn-finstat" role="button" target="_blank"><span class="glyphicon glyphicon-stats"></span> Finstat.sk</a>');
                    $('.fin_foaf tr:nth-child(1) td:nth-child(2)', jiraOkno).html('<a href="http://foaf.sk/?q=' + $(this).text() + '" class="btn btn-foaf" role="button" target="_blank"><span class="glyphicon glyphicon-stats"></span> Foaf.sk</a>');
                } else if (company_index !== null && company_index == index) {
                    $('.fin_foaf tr:nth-child(1) td:nth-child(1)', jiraOkno).html('<a href="http://www.finstat.sk/Hladaj?query=' + $(this).text() + '" class="btn btn-finstat" role="button" target="_blank"><span class="glyphicon glyphicon-stats"></span> Finstat.sk</a>');
                    $('.fin_foaf tr:nth-child(1) td:nth-child(2)', jiraOkno).html('<a href="http://foaf.sk/?q=' + $(this).text() + '" class="btn btn-foaf" role="button" target="_blank"><span class="glyphicon glyphicon-stats"></span> Foaf.sk</a>');
                }

                $('.body tr:nth-child(' + (index + 1) + ') td:nth-child(2)', jiraOkno).text($(this).text());
            });
        });
    }
    ;

    $(document).on('page:load', handleJiraOkno())
</script>